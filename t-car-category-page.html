<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../t-shared-lib/t-date-behavior.html">
<link rel="import" href="t-car-result-api.html">
<link rel="import" href="t-car-category-item.html">
<link rel="import" href="t-filter-api.html">
<link rel="import" href="../t-sessionstorage/t-sessionstorage.html">
<link rel="import" href="../t-notify/t-notify.html">
<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->
<dom-module id="t-car-category-page">
    <template>
        <style>
        :host {
            display: block;
        }
        </style>

        <t-notify id="notify"></t-notify>

		<t-car-result-api
            id="resultApi"
            loading={{loading}}
            api-base-url="{{apiBaseUrl}}"
            api-relative-url="api/Car/results/[[searchId]]"
            auth-token="[[authToken]]"
            on-t-car-result-api-success="onResultSuccess"
            on-t-car-result-api-error="onResultError">
        </t-car-result-api>

		<t-filter-api
            id="filterApi"
            loading={{loading}}
            api-base-url="[[apiBaseUrl]]"
            api-relative-url="api/car/filter/[[searchId]]"
            auth-token="[[authToken]]"
            on-t-filter-api-success="onFilterSuccess"
            on-t-filter-api-error="onFilterError">
        </t-filter-api>

        <t-sessionstorage
            id="sessionStore"
            api-url-format="{{apiUrlFormat}}"
            on-t-sessionstorage-save-success="onSessionSave"
            on-t-sessionstorage-load-success="onSessionLoad">
        </t-sessionstorage>

        <h1>category result page</h1>

        <template id="list" is="dom-repeat" items="{{list}}">
            <t-car-category-item
                category= "{{item.category}}"
                url="{{item.url}}"
                price="{{item.price}}"
                currency="{{currency}}"
                capacity-range="{{item.capacityRange}}"
                baggage-range="{{item.baggageRange}}"
                is-automatic="{{item.isAutomatic}}"
                is-manual="{{item.isManual}}"
                door-range="{{item.doorRange}}"
                air-conditioning="{{item.airConditioning}}">
            </t-car-category-item>
        </template>

    </template>
    <script>
    (function() {

        var categoryResult = [];
        var filterResult = [];
        var searchCriteria = null;
        var listSummary = [];

        var numberMapping = {
            'One': 1,
            'Two': 2,
            'Three': 3,
            'Four': 4,
            'Five': 5,
            'Six': 6,
            'Seven': 7,
            'Eight': 8,
            'Nine': 9,
            'Ten': 10
        };

        Polymer({
            is: 't-car-category-page',

            behaviors: [TravelNxt.Behaviors.DateBehavior],

            properties: {

                /*
                 * <p>This string is query string containing token value</p>
                */
                authToken: {
                    type: String,
                    value: ''
                },

                /*
                 * <p>This property holds the value of api base URL</p>
                */
                apiBaseUrl: {
                    type: String,
                    value: ''
                },

                /*
                 * <p>This property holds the value of web api URL format</p>
                */
                apiUrlFormat: {
                    type: String,
                    value: ''
                },

                /*
                 * <p>This property holds the value of currency</p>
                */
                currency: {
                    type: String,
                    value: 'USD'
                },

                /*
                 * <p>This property holds the value of search id</p>
                */
                searchId: {
                    type: String,
                    value: '',
                    observer:'_onSearchIdUpdate'
                },

                list: {
                    type: Array,
                    value:[],
                    observer:'_renderList'
                },

                /*
                 * <p>This property is collection of keys used to store data in session</p>
                */
                _sessionKeys: {
                    type: Object,
                    value: function() {
                        return {
                            categoryResult : 'CAR_CATEGORY_RESULT',
                            filterResult:'CAR_FILTER_RESULT',
                            searchCriteria : 'CAR_SEARCH_CRITERIA',
                            searchId:'CAR_SEARCH_ID'
                        };
                    },
                    readOnly: true
                }
            },

            attached: function () {
            	
            	if (!this.authToken) {
            		return;
            	}

                if (!searchCriteria) {
                   this._getFromSessionStore(this._sessionKeys.searchCriteria);
                }

            	if (!this.searchId) {
             	   this._getFromSessionStore(this._sessionKeys.searchId);
            	}
            },

            /*
             * <p>Event handler method called when `t-car-search-api-success` event is fired</p>
            */
            onResultSuccess: function (e) {

                if (!e.detail) {
                    this.$.notify.active = true;
                    this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
                    console.error('something blew up!');
                    return;
                }
                categoryResult = e.detail.inventories;
                this._saveInSessionStore(this._sessionKeys.categoryResult, e.detail.inventories);
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            onResultError: function (e) {
                this.$.notify.active = true;
                this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
                console.error(e.detail);
                this.fire('t-car-search-error', e.detail);
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            onFilterSuccess: function (e) {

                if (!e.detail) {
                    this.$.notify.active = true;
                    this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
                    console.error('something blew up!');
                    return;
                }

                filterResult = e.detail.filters;
                this._saveInSessionStore(this._sessionKeys.filterResult, e.detail.filters);
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            onFilterError: function (e) {            	
            },

            /*
             * <p>Event handler method called when `t-sessionstorage-save-success` event is fired</p>
            */
            onSessionSave: function (e) {

            	switch(this.$.sessionStore.key) {

    				case this._sessionKeys.categoryResult:                        
                        this._processResultData()
        				break;

				    case this._sessionKeys.filterResult:
				    	this._processResultData();
				        break;

				    case this._sessionKeys.searchCriteria:
				        break;

				    case this._sessionKeys.searchId:
				        break;

				    default:
				    	console.error(this.$.sessionStore.key, ' is invalid');
				    	break;
		    	}
            },

            /*
             * <p>Event handler method called when `t-sessionstorage-load-success` event is fired</p>
            */
            onSessionLoad: function (e) {

            	switch(this.$.sessionStore.key) {

    				case this._sessionKeys.categoryResult:
        				break;

				    case this._sessionKeys.filterResult:
				        break;

				    case this._sessionKeys.searchCriteria:
                        searchCriteria = this.$.sessionStore.value;
				    	this._processResultData();
				        break;

				    case this._sessionKeys.searchId:
                        this.searchId = this.$.sessionStore.value;
				        break;

				    default:
				    	console.error(this.$.sessionStore.key, ' is invalid');
				    	break;
		    	}
            },

            /*
             * <p>This method resets the view by using saved data in session</p>
             * <p>It calles child views' resetView method to propogate the reset event</p>
            */
            resetView: function () {
            	
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            _renderList: function () {
                if (this.list && this.list.length) {
                    this.$.list.render();
                }
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            _onSearchIdUpdate :function () {
                if (this.searchId) {
                    this.$.resultApi.queryParams = [{
                        '$select': 'Category,Capacity,Baggage,AirConditioning,Transmission,Doors,HeroImageUrl'
                    }];
                    this.$.resultApi.search();
                    this.$.filterApi.getFilters();
                }
            },

            /*
             * <p>This is page component level method to get data from session</p>
             * <p>This should be moved in page component behaviour</p>
            */
            _getFromSessionStore: function (key) {

                if (!key) {
                    return;
                }

                this.$.sessionStore.key = key;

                return this.$.sessionStore.load();
            },

            /*
             * <p>This page component level method to save data in session</p>
             * <p>This should be moved in page component behaviour</p>
            */
            _saveInSessionStore: function (key, value) {

                if (!key || !value) {
                    return;
                }

                this.$.sessionStore.key = key;
                this.$.sessionStore.value = value;

                this.$.sessionStore.save();
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            _processResultData: function () {

                if (!categoryResult.length || !filterResult.length || !searchCriteria) {
                // if (!categoryResult.length || !filterResult.length) {
                    return;
                }

                this._translateCategoryResult();
                this.list = listSummary;
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            _translateCategoryResult: function () {

                if (!filterResult || !filterResult.length) {
                    return [];
                }
                var categoryFilter = filterResult.find(function (item, index, array) {
                    return item.category === 'Category';
                });

                var noOfDays = this._dateDiff(searchCriteria.pickupDate.date, searchCriteria.dropoffDate.date);
                var noOfHours = this._getTimeDiff(searchCriteria.pickupDate.time, searchCriteria.dropoffDate.time);

                for (var i = 0; i < categoryFilter.items.length; i++) {
                    this._groupCategoryItems(categoryFilter.items[i].name, this._getAvgPrice(categoryFilter.items[i].value, noOfDays, noOfHours));
                }
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            _getAvgPrice: function (price, noOfDays, noOfHours) {
                if (noOfHours > 0) {                 
                    noOfDays +=1 ;
                }
                price = price / noOfDays;
                return Math.ceil(price);
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            _groupCategoryItems: function (categoryName, minPrice) {

                var perCategoryResult = categoryResult.filter(function (item, index, array) {
                    return item.category.toLowerCase() === categoryName.toLowerCase() ||
                           item.category.toLowerCase() === 'notspecified';
                }, this);

                if (perCategoryResult && perCategoryResult.length) {
                    this._buildCategoryListItem(perCategoryResult, minPrice);
                }
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            _buildCategoryListItem: function (perCategoryResult, minPrice) {

                var doorList = [];
                var baggageList = [];
                var capacityList = [];
                var url = perCategoryResult[0].heroImageUrl;
                var categoryName = perCategoryResult[0].category;
                var isAutomatic = false;
                var isManual = false;
                var airConditioning = false;

                for (var i = 0; i < perCategoryResult.length; i++) {
                    doorList.push(perCategoryResult[i].doors);
                    baggageList.push(perCategoryResult[i].baggage);
                    capacityList.push(perCategoryResult[i].capacity);
                    isAutomatic = isAutomatic || perCategoryResult[i].transmission.toLowerCase() === 'automatic';
                    isManual = isManual || perCategoryResult[i].transmission.toLowerCase() === 'manual';
                    airConditioning = airConditioning || perCategoryResult[i].airConditioning.toLowerCase() === 'yes';
                }

                doorList = this._parseCount(this._getUniqueItems(doorList));
                baggageList = this._getUniqueItems(baggageList);
                capacityList = this._parseCount(this._convertCapacity(this._getUniqueItems(capacityList)));

                var doorRange = this._getFeaureRange(doorList);
                var baggageRange = this._getFeaureRange(baggageList);
                var capacityRange = this._getFeaureRange(capacityList);

                listSummary.push({
                    category: categoryName,
                    doorRange: doorRange,
                    baggageRange: baggageRange,
                    capacityRange: capacityRange,
                    url: url,
                    price: minPrice,
                    airConditioning: airConditioning,
                    isAutomatic : isAutomatic,
                    isManual : isManual
                });
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            _getFeaureRange: function (feature) {
                var minValue = Math.min.apply(null, feature);
                var maxValue = Math.max.apply(null, feature);
                if (minValue === maxValue) {
                    return minValue;
                }else{
                    return minValue + ' - ' + maxValue;
                }
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            _convertCapacity: function (capacityList) {
                var list = [];
                for (var i = 0; i < capacityList.length; i++) {
                    if (capacityList[i].indexOf('To') > -1) {
                        var splitCapacity = capacityList[i].split('To');
                        list.push(splitCapacity[0],splitCapacity[1]);
                    }                
                }
                return this._getUniqueItems(list);
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            _parseCount: function (array) {
                for (var i = 0; i < array.length; i++) {
                    array[i] = numberMapping[array[i]];
                }
                return array;
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            _getUniqueItems: function (array) {
                var u = {}, a = [];
                for(var i = 0, l = array.length; i < l; ++i){
                   if(u.hasOwnProperty(array[i])) {
                     continue;
                   }
                   a.push(array[i]);
                   u[array[i]] = 1;
                }
                return a;
            }
        });
    })();
    </script>
</dom-module>
