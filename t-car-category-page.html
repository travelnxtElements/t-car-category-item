<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../t-sessionstorage/t-sessionstorage.html">
<link rel="import" href="../t-shared-lib/t-date-behavior.html">
<link rel="import" href="t-car-result-api.html">
<link rel="import" href="t-car-category-item.html">
<link rel="import" href="t-filter-api.html">
<link rel="import" href="t-category-result-behavior.html">
<link rel="import" href="../t-notify/t-notify.html">
<link rel="import" href="../t-search-overlay/t-search-overlay.html">
<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->
<dom-module id="t-car-category-page">
    <template>
        <style>
        :host {
            display: block;
        }
        .container {
            background-color: #f2f2f2;
            padding:10px;
        }
        .categoryItem {
            margin-bottom:10px;
        }
        .categoryItem:last-of-type {
            margin-bottom:0;
        }
        </style>

        <t-notify id="notify"></t-notify>

        <content select="t-header"></content>

        <t-search-overlay icon="maps:directions-car" id="loadingOverlay">
            <div class="data">
                <div class="font-12 text-center secondary-text overlayData">
                    <div class="font-16">
                        Pick-up from
                    </div>
                    <div>
                        [[searchCriteria.pickupLocation.formattedAddress]]
                    </div>
                    <div class="margin-bottom-medium">[[_getDate(searchCriteria.pickupDate)]]&nbsp;[[searchCriteria.pickupTime]]</div>
                    <br>
                    <div class="font-16">
                        Drop-of to
                    </div>
                    <div>
                        [[searchCriteria.dropoffLocation.formattedAddress]]
                    </div>
                    <div>[[_getDate(searchCriteria.dropoffDate)]]&nbsp;[[searchCriteria.dropoffTime]]</div>
                </div>
            </div>
            <div class="footer">
                <img src="[[siteLogoUrl]]" title="[[siteLogoUrl]]" alt="" style="width:232px;">
            </div>
        </t-search-overlay>
        <t-car-result-api
            id="resultApi"
            loading="{{loading}}"            
            api-base-url="[[apiBaseUrl]]"
            api-relative-url="api/Car/results/[[queryParams.searchId]]"
            auth-token="[[authToken]]"
            on-t-car-result-api-success="onResultSuccess"
            on-t-car-result-api-error="onResultError">
        </t-car-result-api>

        <t-filter-api
            id="filterApi"
            loading="{{loading}}"
            api-base-url="[[apiBaseUrl]]"
            api-relative-url="api/car/filter/[[queryParams.searchId]]"
            auth-token="[[authToken]]"
            on-t-filter-api-success="onFilterSuccess"
            on-t-filter-api-error="onFilterError">
        </t-filter-api>
        <div class="container">
            <template id="list" is="dom-repeat" items="[[list]]">
                <t-car-category-item
                    class="categoryItem" 
                    on-tap="_itemSelected"
                    category= "[[item.category]]"
                    url="[[item.url]]"
                    price="[[item.price]]"
                    currency="[[currency]]"
                    capacity-range="[[item.capacityRange]]"
                    baggage-range="[[item.baggageRange]]"
                    gear="[[item.gear]]"
                    door-range="[[item.doorRange]]"
                    air-conditioning="[[item.airConditioning]]">
                </t-car-category-item>
            </template>

        </div>

        <t-sessionstorage
            id="sessionStore"
            key="Car_Category_Data"
            api-url-format="[[apiUrlFormat]]"
            on-t-sessionstorage-load-success="onSessionLoad">
        </t-sessionstorage>
    </template>
    <script>
        (function () {

            Polymer({
                is: 't-car-category-page',

                behaviors: [
                    TravelNxt.Behaviors.DateBehavior,
                    TravelNxt.Behaviors.CategoryResultBehavior
                ],

                properties: {

                    visible: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    /*
                     * <p>This string is query string containing token value</p>
                     */
                    authToken: String,

                    /*
                     * <p>This property holds the value of api base URL</p>
                     */
                    apiBaseUrl: String,


                    /*
                     * <p>This property holds the value of web api URL format</p>
                     */
                    apiUrlFormat: String,


                    /*
                     * <p>This property holds the value of currency</p>
                     */
                    currency: {
                        type: String,
                        value: 'USD'
                    },

                    /*
                     * <p>This property holds the value of selected category</p>
                     */
                    selectedCategory: {
                        type: String,
                        notify: true
                    },

                    /*
                     * <p>This property holds the value of minimum price for selected category</p>
                     */
                    minPrice: {
                        type: String,
                        notify: true
                    },

                    list: {
                        type: Array,
                        value: [],
                        observer: '_renderList'
                    },

                    queryParams: {
                        type: Object,
                        notify: true
                    }
                },


                observers: [
                    '_processResultData(_categoryResult, _filterResult, searchCriteria)',
                    '_onSearchIdUpdate(queryParams.searchId, visible)'
                ],

                /*
                 * <p>Event handler method called when `t-car-search-api-success` event is fired</p>
                 */
                onResultSuccess: function (e) {

                    if (!e.detail) {
                        this.$.notify.active = true;
                        this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
                        console.error('something blew up!');
                        return;
                    }
                    this._categoryResult = e.detail.inventories;
                },

                /*
                 * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
                 */
                onResultError: function (e) {
                    this.$.notify.active = true;

                    //ending the overlay
                    this.$.loadingOverlay.value = 100;

                    this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
                    console.error(e.detail);
                    this.fire('t-car-search-error', e.detail);
                },

                /*
                 * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
                 */
                onFilterSuccess: function (e) {

                    if (!e.detail) {
                        this.$.notify.active = true;

                        //ending the overlay
                        this.$.loadingOverlay.value = 100;

                        this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
                        console.error('something blew up!');
                        return;
                    }

                    this._filterResult = e.detail.filters;
                },

                /*
                 * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
                 */
                onFilterError: function (e) {
                    this.$.notify.active = true;

                    //ending the overlay
                    this.$.loadingOverlay.value = 100;

                    this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
                    console.error(e.detail);
                    this.fire('t-car-search-error', e.detail);
                },



                /*
                 * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
                 */
                _renderList: function () {
                    if (this.list && this.list.length) {
                        this.$.list.render();
                        //ending the overlay
                        this.$.loadingOverlay.value = 100;
                    }
                },

                /*
                 * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
                 */
                _onSearchIdUpdate: function (searchId, visible) {
                    if (!searchId || !visible) {
                        return;
                    }
                    this.$.sessionStore.load();

                    //starting the overlay
                    this.$.loadingOverlay.value = 0;
                    this.$.loadingOverlay.active = true;


                    this.$.notify.active = false;

                    this.$.resultApi.queryParams = [{
                        '$select': 'Category,Capacity,Baggage,AirConditioning,Transmission,Doors,HeroImageUrl'
                    }];
                    this.$.resultApi.search();
                    this.$.filterApi.getFilters();
                },

                _itemSelected: function (e) {
                    this.minPrice = e.currentTarget.price;
                    this.selectedCategory = e.currentTarget.category;

                    var sessionObject = this._getSessionObject();

                    this.$.sessionStore.value = sessionObject;
                    this.$.sessionStore.save();

                    this.queryParams = {
                        searchId: this.queryParams.searchId,
                        selectedCategory: sessionObject.selectedCategory,
                        minPrice: sessionObject.minPrice
                    }

                    this.fire('car-category-select', sessionObject);
                },

                onSessionLoad: function () {
                    if (this.$.sessionStore.value) {
                        this.selectedCategory = this.$.sessionStore.value.selectedCategory;
                        this.minPrice = this.$.sessionStore.value.minPrice;
                    }
                },

                _getSessionObject: function () {
                    return {
                        selectedCategory: this.selectedCategory,
                        minPrice: this.minPrice
                    };
                }
            });
        })();
    </script>

</dom-module>
