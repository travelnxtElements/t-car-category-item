<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../t-sessionstorage/t-sessionstorage.html">
<link rel="import" href="../t-shared-lib/t-date-behavior.html">
<link rel="import" href="t-car-result-api.html">
<link rel="import" href="t-car-category-item.html">
<link rel="import" href="t-filter-api.html">
<link rel="import" href="t-category-result-behavior.html">
<link rel="import" href="../t-notify/t-notify.html">
<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->
<dom-module id="t-car-category-page">
    <template>
        <style>
        :host {
            display: block;
        }
        </style>

        <content select="t-header"></content> 

        <t-notify id="notify"></t-notify>

        <t-car-result-api
            id="resultApi"
            loading="{{loading}}"            
            api-base-url="[[apiBaseUrl]]"
            api-relative-url="api/Car/results/[[searchId]]"
            auth-token="[[authToken]]"
            on-t-car-result-api-success="onResultSuccess"
            on-t-car-result-api-error="onResultError">
        </t-car-result-api>

        <t-filter-api
            id="filterApi"
            loading="{{loading}}"
            api-base-url="[[apiBaseUrl]]"
            api-relative-url="api/car/filter/[[searchId]]"
            auth-token="[[authToken]]"
            on-t-filter-api-success="onFilterSuccess"
            on-t-filter-api-error="onFilterError">
        </t-filter-api>

        <template id="list" is="dom-repeat" items="[[list]]">
            <t-car-category-item on-tap="_itemSelected"
                category= "[[item.category]]"
                url="[[item.url]]"
                price="[[item.price]]"
                currency="[[currency]]"
                capacity-range="[[item.capacityRange]]"
                baggage-range="[[item.baggageRange]]"
                is-automatic="[[item.isAutomatic]]"
                is-manual="[[item.isManual]]"
                door-range="[[item.doorRange]]"
                air-conditioning="[[item.airConditioning]]">
            </t-car-category-item>
        </template>

        <t-sessionstorage
            id="sessionStore"
            key="Car_Category_Data"
            api-url-format="[[apiUrlFormat]]"
            on-t-sessionstorage-load-success="onSessionLoad">
        </t-sessionstorage>
    </template>
    <script>
        (function() {

            Polymer({
                is: 't-car-category-page',

                behaviors: [
                    TravelNxt.Behaviors.DateBehavior,
                    TravelNxt.Behaviors.CategoryResultBehavior
                ],

                properties: {

                    /*
                     * <p>This string is query string containing token value</p>
                     */
                    authToken: String,
                       
                    /*
                     * <p>This property holds the value of api base URL</p>
                     */
                    apiBaseUrl: String,
                        

                    /*
                     * <p>This property holds the value of web api URL format</p>
                     */
                    apiUrlFormat: String,
                       

                    /*
                     * <p>This property holds the value of currency</p>
                     */
                    currency: {
                        type: String,
                        value: 'USD'
                    },

                    /*
                     * <p>This property holds the value of search id</p>
                     */
                    searchId: {
                        type: String,
                        value: '',
                        observer: '_onSearchIdUpdate'
                    },

                    /*
                     * <p>This property holds the value of selected category</p>
                     */
                    selectedCategory: {
                        type: String,
                        notify: true
                    },

                    /*
                     * <p>This property holds the value of minimum price for selected category</p>
                     */
                    minPrice: {
                        type: String,
                        notify: true
                    },

                    list: {
                        type: Array,
                        value: [],
                        observer: '_renderList'
                    }
                },

                
                observers: [
                    '_processResultData(_categoryResult, _filterResult, searchCriteria)'
                ],
                
                /*
                 * <p>Event handler method called when `t-car-search-api-success` event is fired</p>
                 */
                onResultSuccess: function(e) {

                    if (!e.detail) {
                        this.$.notify.active = true;
                        this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
                        console.error('something blew up!');
                        return;
                    }
                    this._categoryResult = e.detail.inventories;
                },

                /*
                 * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
                 */
                onResultError: function(e) {
                    this.$.notify.active = true;
                    this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
                    console.error(e.detail);
                    this.fire('t-car-search-error', e.detail);
                },

                /*
                 * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
                 */
                onFilterSuccess: function(e) {

                    if (!e.detail) {
                        this.$.notify.active = true;
                        this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
                        console.error('something blew up!');
                        return;
                    }

                    this._filterResult = e.detail.filters;
                },

                /*
                 * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
                 */
                onFilterError: function(e) {
                    this.$.notify.active = true;
                    this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
                    console.error(e.detail);
                    this.fire('t-car-search-error', e.detail);
                },               

                /*
                 * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
                 */
                _renderList: function() {
                    if (this.list && this.list.length) {
                        this.$.list.render();
                    }
                },

                /*
                 * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
                 */
                _onSearchIdUpdate: function() {
                    if (!this.searchId) {
                        return;
                    }

                    this.$.notify.active = false;
                    
                    this.$.sessionStore.load();

                    this.$.resultApi.queryParams = [{
                        '$select': 'Category,Capacity,Baggage,AirConditioning,Transmission,Doors,HeroImageUrl'
                    }];
                    this.$.resultApi.search();
                    this.$.filterApi.getFilters();
                },

                _itemSelected: function (e) {
                    this.minPrice = e.currentTarget.price;
                    this.selectedCategory = e.currentTarget.category;
                    this.$.sessionStore.value = this._getSessionObject();
                    this.$.sessionStore.save();
                    this.fire('car-category-select',this._getSessionObject());
                },

                onSessionLoad: function () {
                    if (this.$.sessionStore.value) {
                        this.selectedCategory = this.$.sessionStore.value.selectedCategory;
                        this.minPrice = this.$.sessionStore.value.minPrice;
                    }
                },

                _getSessionObject: function () {
                    return {
                        selectedCategory : this.selectedCategory,
                        minPrice : this.minPrice
                    };
                }
            });
        })();
    </script>

</dom-module>
